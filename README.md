# Documentation for cMoflon (UNDER CONSTRUCTION)
Documentation for cMoflon, the eMoflon derivate for generating Contiki code
----

If you encounter any problems, please post an issue (https://github.com/eMoflon/cmoflon/issues) or send me (Roland Kluge) a message

## How to set up a small case study (walkthrough)

### Setup: How to install cMoflon and all required software
The currently requires a mixed environment with a Windows system (for cMoflon/eMoflon and Enterprise Architect) and a Linux VM (provided as Instant Contiki).
This version of cMoflon has been tested with Eclipse Neon.2 (4.6.2) and eMoflon 2.26.0 and Enterprise Architect 12

1. **Install Eclipse with Modeling Components Neon.2 (or newer)**
  * All Eclipse packages are available here: https://eclipse.org/downloads/
1. **Install Enterprise Architect 12 (or newer)**
  * A 30-days trial version of Enterprise Architect is available here: https://www.sparxsystems.de/uml/download-trial/
1. **Install eMoflon 2.26.0**
  * To install eMoflon in Eclipse use the following update site: http://emoflon.github.io/eclipse-plugin/emoflon_2.26.0/update-site2/
  * You only need to install the feature *eMoflon Core*
  * Additionally, download, unpack and install the eMoflon addin for Enterprice Architect from here: https://emoflon.github.io/eclipse-plugin/emoflon_2.26.0/update-site2/ea-ecore-addin.zip
1. **Install cMoflon 1.0.0**
  * Update Site: http://emoflon.github.io/cmoflon/update-site/
  * You may also use the following: <a href="http://marketplace.eclipse.org/marketplace-client-intro?mpc_install=3266408" class="drag" title="Drag to your running Eclipse workspace."><img class="img-responsive" src="https://marketplace.eclipse.org/sites/all/themes/solstice/public/images/marketplace/btn-install.png" alt="Drag to your running Eclipse workspace." /></a> from Eclipse Marketplace via drap and drop.
1. **Get Contiki**
 * Download the *Instant Contiki 3.0* VM from here: https://sourceforge.net/projects/contiki/files/Instant%20Contiki/Instant%20Contiki%203.0/InstantContiki3.0.zip/download 
 * You will need Virtual Box to run the VM (https://www.virtualbox.org/)
 * Detailed setup instructions can be found here: http://www.contiki-os.org/start.html
   * Instant Contiki fix: To run the sample simulation, you will need to call ```git submodule update --init```. 
     Otherwise, starting Cooja will fail.
1. **Get ToCoco framework**
 We suggest that you checkout the ToCoCo framework inside the Instant Contiki VM
 * A snapshot of the proper version will be made available later here: https://github.com/steinmic/TopologyControl
 * Clone the Contiki evaluation framework from here (non-public): 
   * URL: https://git.tk.informatik.tu-darmstadt.de/michael.stein/topology-control-evaluation.git
   * Switch to branch CMoflon_Evaluation
 * The root folder of the working copy will be refered to as *$ToCoCo* in the following.
 
## How to specify a sample TC algorithm/test the existing TC algorithms
1. Open a fresh workspace in Eclipse.
1. Navigate to *File->New->Other->eMoflon*, select *New cMoflon Metamodel Wizard* add a name (e.g., *cMoflonTestSpecification*), and press *Finish*.
1. This will create a new project, a so-called metamodel project. Open it and double-click the .eap file
1. Specify your TC algorithm or algorithms according to the pre-implemented ones.
1. Hit the *Validate* button and select your project in eclipse and refresh it. This will create two new projects, named after the corresponding ECore Package in Enterprise Architect.
 * The project ending with ```_C``` contains the Contiki code
 * The other project contains regular eMoflon code (e.g., for unit testing or Java-based debugging).
1. Inside the Contiki project (the one ending with ```_C```), edit the *cMoflon.properties* for customizing the generated code. Fill the property file according to the instructions.
1. Select the Contiki project and hit the black-hammer button, the generated code is placed in the */gen* folder.

### How to test a TC algorithm generated by cMoflon in Cooja Simulator
Cooja is the network simulator that ships with Contiki.
It is quite a powerful simulator for a first test of your code.
We suggest to mount a [shared folder](https://help.ubuntu.com/community/VirtualBox/SharedFolders) to easily copy cMoflon-generated files to the Instant Contiki VM.

1. Copy both generated files (.c and .h) from the */gen* folder of your cMoflon workspace into the folder *$ToCoCo/src/components/topologycontrol/*
1. Add a line for the .c file to *$ToCoCo/src/components/topologycontrol/Makefile*
1. Add the new constant (found in the .c file in the PROCESS section) to *$ToCoCo/src/app-conf-constants.h*
1. Copy *$ToCoCo/src/app-conf-default*, and remove the *_default* suffix
 * Add the following lines
   * ```#define TOPOLOGYCONTROL_LINKS_HAVE_STATES``` (This ensures that the type ```neighbor_t``` has a member called ```state```)
   * ```#define COMPONENT_TOPOLOGYCONTROL_CMOFLONDEMOLANGUAGE_C_BROADCASTHOPCOUNT_IMMEDIATE_MIN (15-5)```
   * ```#define COMPONENT_TOPOLOGYCONTROL_CMOFLONDEMOLANGUAGE_C_BROADCASTHOPCOUNT_IMMEDIATE_MIN (15+5)```
   * ```#define COMPONENT_TOPOLOGYCONTROL_CMOFLONDEMOLANGUAGE_C_BROADCASTHOPCOUNT_SMALLDELAY_MIN (15-5)```
   * ```#define COMPONENT_TOPOLOGYCONTROL_CMOFLONDEMOLANGUAGE_C_BROADCASTHOPCOUNT_SMALLDELAY_MAX (15+5)```
   * ```#define COMPONENT_TOPOLOGYCONTROL_CMOFLONDEMOLANGUAGE_C_BROADCASTHOPCOUNT_PERIODIC_MIN (15-5)```
   * ```#define COMPONENT_TOPOLOGYCONTROL_CMOFLONDEMOLANGUAGE_C_BROADCASTHOPCOUNT_PERIODIC_MAX (15+5)```
 * Adjust the settings within to your wishes
1. Copy *$ToCoCo/src/Makefile-conf-default.include*, and remove the *_default*, 
 * Set the *Contiki* property to the contiki path in the VM (e.g., ```Contiki=/home/user/contiki``` in Instant Contiki)
 * **Do not use IPv6** (the resulting image would be too large for Sky motes): ```NETWORK_IPV6 = 0```
 *Alternatively, you can use the files provided inside the /resources folder.
1. Open a terminal, navigate to */contiki/tools/cooja*, and use the command ```ant run``` to start the Cooja Simulator.
1. Hit *CTRL+N* to create a new simulation
1. Navigate to *Motes->Add motes->Create New Mote Type->Sky mote*, browse to *$ToCoCo/src/app.c*, and hit *Compile*.
1. After compiling is done, create the motes, and run the simulation.

### How to test a TC algorithm generated by cMoflon using FlockLab
FlockLab (https://www.flocklab.ethz.ch/) is a wireless sensor testbed at ETH Zurich.

1. You will need a Flocklab account for testing so create one here: https://www.flocklab.ethz.ch/user/login.php
1. Follow all the Steps for Cooja until compilation has terminated.
1. Then, unmount the drive from the VM
1. Go to the test image section (https://www.flocklab.ethz.ch/user/images.php) and upload the compiled *app.sky* file, located in *TCEval/src*.
1. Copy the ImageID into the xml configuration provided in the */resources* folder in the Eclipse Project and then upload it to the test section
1. After the Test is run, you will receive an e-mail with the results in a zip folder.

### How to use the evaluation tools
